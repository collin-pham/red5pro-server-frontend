<html lang="en">
<head>
<title>Flash View</title>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<meta name="author" content="Paul Gregoire">
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
<link rel="stylesheet" type="text/css" href="default.css">
<script type="text/javascript" src="swfobject.js"></script>
<script type="text/javascript">
    "use strict"
    var appName = getQueryVariable('app') || 'webrtc';
    // subscriber id
    var subscriberId = 'subscriber-' + Math.floor(Math.random() * 0x10000).toString(16);
    // our channel / room name
    var channelName = getQueryVariable('channelId');
    // type of stream for publish and playback
    var streamType = 'flash';

    // swf stuff
    var params={};params.quality="high";params.allowscriptaccess="sameDomain";
    // participant 1
    var a1vars={};a1vars.host=location.hostname;a1vars.appName=appName;a1vars.roomName=channelName;a1vars.streamName="publisher1";
    var a1attrs={};a1attrs.id="publisher1";a1attrs.name="publisher1";a1attrs.align="middle";
    swfobject.embedSWF("subscriber.swf?" + subscriberId, "publisher1", "320", "240", "11.1.0", "", a1vars, params, a1attrs);
    // participant 2
    var a2vars={};a2vars.host=location.hostname;a2vars.appName=appName;a2vars.roomName=channelName;a2vars.streamName="publisher2";
    var a2attrs={};a2attrs.id="publisher2";a2attrs.name="publisher2";a2attrs.align="middle";
    swfobject.embedSWF("subscriber.swf?" + subscriberId, "publisher2", "320", "240", "11.1.0", "", a2vars, params, a2attrs);

    // communication channel
    var wsprotocol = location.protocol == 'https:' ? 'wss' : 'ws';
    var wsport = location.protocol == 'https:' ? '8083' : '8081';
    var context = channelName ? appName + '/' + channelName : appName;
    var socket = new WebSocket(wsprotocol + '://' + location.hostname + ':' + wsport + '/' + context + '?id=' + subscriberId);

    // called when the socket opens; this opens the channel / room
    socket.onopen = function() {
      console.log('Socket opened');
    };

    // messages coming from the websocket
    socket.onmessage = function(message) {
      console.log(message);
      if (message.data) {
        var json = JSON.parse(message.data);
        if (json.isAvailable !== undefined) {
          console.log('Message - isAvailable: ' + json.isAvailable);
          if (json.isAvailable) {
            var streamName = json.streamName.toString();
            doPlayback(true, streamName);
          } else {
            console.log('Stream is not available');
          }
        }
        if (json.data !== undefined) {
          if (json.data.message !== undefined) {
            console.log('Message: ' + json.data.message);
            if (json.data.type === 'error') {
              if (json.data.detail) {
                alert('Error: ' + json.data.message + '\n' + json.data.detail);
              } else {
                alert('Error: ' + json.data.message);
              }
            }
          }
        }
      } else {
        console.warn('No message data');
      }
    };

    // exits and cleans up
    function closeAndExit() {
      if (socket !== undefined) {
        // disconnect the flash swf
        document.getElementById('publisher1').disconnect();
        // disconnect the flash swf
        document.getElementById('publisher2').disconnect();
        // close
        console.log('Closing the socket');
        socket.close();
      }
    }

    // playback
    function doPlayback(start, name) {
      console.log((start ? 'Play: ' : 'Stop:') + name);
      var swf = swfobject.getObjectById(name);
      if (swf !== undefined) {
        start ? swf.connect(false) : swf.disconnect();
        console.log("Playing? " + swf.isPlaying());
      }
    }

    function getQueryVariable(variable) {
        var query = window.location.search.substring(1);
        var vars = query.split('&');
        for (var i = 0; i < vars.length; i++) {
            var pair = vars[i].split('=');
            if (decodeURIComponent(pair[0]) == variable) {
                return decodeURIComponent(pair[1]);
            }
        }
        console.log('Query variable %s not found', variable);
    }

    function log(id, message) {
      console.log(id + ' - ' + message);
    }
</script>
</head>
<body>
<div id="container">
  <table id="meeting" width="800" border="0" cellpadding="0" cellspacing="0">
    <tr>
      <td><div id="publisher1"></div></td>
      <td><div id="publisher2"></div></td>
    </tr>
  </table>
  Click on the swf to try playback
</div>
<br /><br />
Control
<br />
<button id="closeAndExit" onclick="closeAndExit()">Exit</button>
</body>
</html>
